<div class="max-w-4xl mx-auto my-8 md:my-12 px-4 pb-24 font-sans text-stone-800" data-controller="recipe-calculation">
  <%= form_with(model: recipe, class: "space-y-10") do |f| %>
    
    <% if recipe.errors.any? %>
      <div class="bg-red-50/50 border-2 border-red-100 p-6 rounded-[2rem]">
        <h3 class="text-sm font-black text-red-500 flex items-center gap-2">
          <span>⚠️</span> 入力内容を確認してください
        </h3>
        <ul class="mt-2 text-xs text-red-400 list-disc list-inside font-bold">
          <% recipe.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8" data-controller="recipe-preview">
      <div class="relative bg-white aspect-square flex flex-col items-center justify-center rounded-[2.5rem] border-4 border-dashed border-orange-200 group cursor-pointer overflow-hidden shadow-sm hover:shadow-md transition-all">
        <img data-recipe-preview-target="preview" 
            src="<%= recipe.image.attached? ? url_for(recipe.image) : '' %>" 
            class="<%= recipe.image.attached? ? '' : 'hidden' %> absolute inset-0 w-full h-full object-cover">
        
        <div data-recipe-preview-target="placeholder" class="<%= recipe.image.attached? ? 'hidden' : 'flex' %> flex flex-col items-center justify-center text-orange-300">
          <div class="p-5 bg-orange-50 rounded-full mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
            </svg>
          </div>
          <span class="text-sm font-black tracking-wider uppercase">写真をのせる</span>
        </div>
        <%= f.file_field :image, class: "absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10", data: { action: "change->recipe-preview#previewImage", recipe_preview_target: "input" } %>
      </div>

      <div class="space-y-6 flex flex-col justify-center">
        <div class="relative">
          <%= f.text_field :title, placeholder: "料理名を入力...", class: "w-full bg-transparent border-b-4 border-orange-200 focus:border-orange-500 focus:ring-0 text-3xl font-black placeholder-orange-200 transition-colors py-2" %>
        </div>
        
        <div class="bg-white/80 backdrop-blur-sm p-6 rounded-[2rem] min-h-[120px] border border-orange-100 shadow-sm">
          <%= f.text_area :description, placeholder: "レシピ説明欄。どんな料理？", class: "w-full bg-transparent border-none focus:ring-0 text-base text-stone-600 placeholder-orange-200 h-full resize-none font-medium leading-relaxed" %>
        </div>

        <% 
          category_order = ["🍱 お弁当・丼・カレー", "🍝 パスタ・うどん・そば・ラーメン", "🥪 パン・サンドイッチ・おにぎり", "🍗 ホットスナック", "🥦 惣菜・サラダ", "💰 その他(金額目安)"]
          all_foods = ConvenienceFood.all.order(:id)
          grouped_options = category_order.map { |cat| [cat, all_foods.select { |f| f.category == cat }.map { |f| [f.name, f.id, { data: { price: f.price } }] }] } 
        %>

        <div class="bg-white/80 p-5 rounded-[2rem] border border-orange-100 shadow-sm">
          <label class="block text-[10px] font-black text-orange-400 uppercase tracking-widest mb-2 px-1 flex items-center gap-1">
            比較する商品 <span class="bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded-sm">必須</span>
          </label>
          <%= f.select :convenience_food_id, grouped_options_for_select(grouped_options, f.object.convenience_food_id), { include_blank: "比較対象を選択" }, 
              { class: "w-full rounded-xl border-orange-100 bg-orange-50/30 text-sm font-bold focus:ring-2 focus:ring-orange-200 focus:border-orange-300 py-3 text-stone-600", 
                data: { action: "change->recipe-calculation#updateComparison", recipe_calculation_target: "convenienceSelect" } } %>
          <div class="mt-3 flex justify-end items-center gap-2 text-stone-400 font-bold">
            <span class="text-[10px]">コンビニ価格:</span>
            <span class="text-stone-600 font-black">¥<span data-recipe-calculation-target="conveniencePriceDisplay"><%= f.object.convenience_food&.price || 0 %></span></span>
          </div>
        </div>  
      </div>
    </div>

    <div class="bg-white/60 p-8 md:p-12 rounded-[3rem] border border-orange-100 shadow-sm" data-controller="recipe-step">
      <div class="flex items-center justify-center gap-3 mb-10">
        <h3 class="text-2xl font-black text-stone-800 tracking-tight">作り方のステップ</h3>
      </div>
      <div class="space-y-8" data-recipe-step-target="container">
        <% current_steps = Array(recipe.steps).flat_map { |s| s.to_s.split("\n") }.reject(&:blank?) %>
        <% current_steps = [""] if current_steps.empty? %>
        <% current_steps.each_with_index do |step, index| %>
          <div class="flex gap-5 items-start step-item group">
            <div class="flex-none w-10 h-10 bg-white text-orange-500 font-black rounded-2xl flex items-center justify-center text-lg shadow-sm border border-orange-100 step-number"><%= index + 1 %></div>
            <div class="flex-grow">
              <%= text_area_tag "recipe[steps][]", step, placeholder: "手順を入力...", class: "w-full bg-white border-orange-50 rounded-[1.5rem] p-5 focus:ring-4 focus:ring-orange-100 focus:border-orange-300 transition-all text-stone-700 font-medium shadow-sm" %>
              <button type="button" data-action="click->recipe-step#remove" class="text-xs text-orange-300 hover:text-red-400 mt-2 font-bold transition-colors ml-2">削除</button>
            </div>
          </div>
        <% end %>
      </div>
      <button type="button" data-action="click->recipe-step#add" class="mt-10 w-full py-4 bg-orange-50 border-2 border-dashed border-orange-200 rounded-3xl text-orange-400 font-black hover:bg-orange-100 transition-all flex items-center justify-center gap-2">＋ ステップを追加</button>
      <template data-recipe-step-target="template">
        <div class="flex gap-5 items-start step-item group mt-8">
          <div class="flex-none w-10 h-10 bg-white text-orange-500 font-black rounded-2xl flex items-center justify-center text-lg shadow-sm border border-orange-100 step-number">NEW_INDEX</div>
          <div class="flex-grow">
            <%= text_area_tag "recipe[steps][]", nil, placeholder: "手順を入力...", class: "w-full bg-white border-orange-50 rounded-[1.5rem] p-5 focus:ring-4 focus:ring-orange-100 focus:border-orange-300 transition-all text-stone-700 font-medium shadow-sm" %>
            <button type="button" data-action="click->recipe-step#remove" class="text-xs text-orange-300 hover:text-red-400 mt-2 font-bold transition-colors ml-2">削除</button>
          </div>
        </div>
      </template>
    </div>

    <div class="bg-orange-100/50 p-8 md:p-12 rounded-[3.5rem] border border-orange-200/50 relative">
      <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
        <h3 class="text-2xl font-black text-stone-800 flex items-center gap-3">
        材料・グラム数
          <span class="bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded-sm">必須</span>
        </h3>
        <div data-controller="modal">
          <button type="button" data-action="click->modal#open" class="text-xs font-black text-orange-600 bg-white px-4 py-2.5 rounded-full hover:bg-orange-50 transition-all shadow-sm border border-orange-100">💡 目安表を確認→</button>
          <%= render 'shared/ingredient_modal' %>
        </div>
      </div>

      <div class="flex flex-col lg:flex-row gap-10 items-start">
        <div class="flex-grow w-full space-y-4">
          <div data-recipe-calculation-target="container" class="space-y-3">
            <%= f.fields_for :recipe_ingredients do |ri_form| %>
              <%= render "ingredient_fields", f: ri_form %>
            <% end %>
          </div>
          <button type="button" data-action="click->recipe-calculation#add" class="w-full py-4 bg-white/40 border-2 border-dashed border-orange-300 rounded-2xl text-orange-400 font-black hover:bg-white/60 transition-all">＋ 材料を追加</button>
        </div>

        <div class="w-full lg:w-72 bg-white p-8 shadow-xl shadow-orange-200/50 flex flex-col items-center justify-center min-h-[220px] sticky top-24 rounded-[3rem] border-2 border-orange-100">
          <span class="text-[10px] font-black text-orange-300 uppercase tracking-[0.2em] mb-4">合計金額</span>
          <div class="text-4xl font-black text-stone-800 flex items-baseline gap-1">
            <span class="text-2xl text-orange-500">¥</span>
            <span data-recipe-calculation-target="totalDisplay"><%= recipe.total_cost || 0 %></span>
          </div>
          <div class="mt-8 pt-6 border-t border-dashed border-orange-100 w-full text-center">
            <span class="text-xs font-black text-white bg-orange-500 px-4 py-1.5 rounded-full shadow-sm">節約金額</span>
            <div class="text-3xl font-black text-orange-600 mt-4 flex items-baseline justify-center gap-1">
              <span class="text-lg">¥</span><span data-recipe-calculation-target="savingsDisplay"><%= recipe.savings_amount || 0 %></span>
            </div>
          </div>
        </div>
      </div>

      <template data-recipe-calculation-target="template">
        <%= f.fields_for :recipe_ingredients, recipe.recipe_ingredients.build, child_index: "NEW_RECORD" do |ri_form| %>
          <%= render "ingredient_fields", f: ri_form %>
        <% end %>
      </template>
    </div>

    <div class="flex flex-col items-center gap-8 py-10">
      <div class="flex items-center gap-6 bg-white/80 backdrop-blur-sm p-4 rounded-full px-8 shadow-sm border border-orange-100">
        <span class="text-sm font-black text-stone-500">みんなに公開する？</span>
        <label class="relative inline-flex items-center cursor-pointer">
          <%= f.check_box :is_public, class: "sr-only peer" %>
          <div class="w-14 h-7 bg-orange-100 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-orange-500"></div>
        </label>
      </div>
      <div class="w-full max-w-md space-y-4 text-center">
        <%= f.submit recipe.new_record? ? "このレシピを登録する" : "変更を保存する", class: "w-full bg-orange-500 hover:bg-orange-600 text-white font-black text-xl py-5 rounded-[2.5rem] shadow-xl shadow-orange-200 transition-all active:scale-95 cursor-pointer" %>
        <%= link_to "キャンセルして戻る", recipes_path, class: "inline-block text-orange-300 font-bold hover:text-orange-500 transition-colors text-sm mt-4" %>
      </div>
    </div>
  <% end %>
</div>
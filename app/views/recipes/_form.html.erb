<div class="max-w-4xl mx-auto my-10 px-4 font-sans text-gray-800" data-controller="recipe-calculation">
  <%= form_with(model: recipe, class: "space-y-6") do |f| %>
    <% if recipe.errors.any? %>
      <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <h3 class="text-sm font-medium text-red-800">保存できませんでした：</h3>
        <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
          <% recipe.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    
    <%# --- 上段：画像と基本情報 --- %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8" data-controller="recipe-preview">
      <div class="relative bg-gray-200 aspect-square flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-gray-400 group cursor-pointer overflow-hidden">
        <img data-recipe-preview-target="preview" 
            src="<%= recipe.image.attached? ? url_for(recipe.image) : '' %>" 
            class="<%= recipe.image.attached? ? '' : 'hidden' %> absolute inset-0 w-full h-full object-cover">
        <div data-recipe-preview-target="placeholder" class="<%= recipe.image.attached? ? 'hidden' : 'flex' %> flex flex-col items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
          </svg>
          <span class="text-lg font-bold text-gray-600">写真をのせる</span>
        </div>
        <%= f.file_field :image, class: "absolute inset-0 opacity-0 cursor-pointer w-full h-full", data: { action: "change->recipe-preview#previewImage", recipe_preview_target: "input" } %>
      </div>

      <div class="space-y-6 text-xl">
        <div class="relative border-b-2 border-gray-400 pb-2">
          <%= f.text_field :title, placeholder: "料理名", class: "w-full bg-transparent border-none focus:ring-0 text-2xl font-bold placeholder-gray-400" %>
        </div>
        <div class="bg-gray-200 p-4 rounded-sm min-h-[150px]">
          <%= f.text_area :description, placeholder: "商品説明", class: "w-full bg-transparent border-none focus:ring-0 text-lg placeholder-gray-500 h-full resize-none" %>
        </div>
        <div class="text-sm bg-blue-50 p-4 rounded-lg border border-blue-100">
          <%= f.label :convenience_food_id, "比較するコンビニ商品", class: "font-bold text-blue-700" %>
          <% convenience_options = ConvenienceFood.all.map { |c| [c.name, c.id, { data: { price: c.price } }] } %>
          <%= f.select :convenience_food_id, convenience_options, { include_blank: "比較対象を選択してください" }, { class: "w-full rounded border-gray-300 mt-1", data: { action: "change->recipe-calculation#updateComparison", recipe_calculation_target: "convenienceSelect" } } %>
          <div class="mt-2 text-right text-gray-600 font-bold">
            コンビニ価格: <span data-recipe-calculation-target="conveniencePriceDisplay"><%= recipe.convenience_food&.price || 0 %></span> 円
          </div>
        </div>
      </div>
    </div>

    <%# --- 中段：作り方 --- %>
    <div class="bg-white p-8 rounded-2xl border-2 border-gray-100 shadow-sm" data-controller="recipe-step">
      <h3 class="text-2xl font-bold text-center mb-8 text-gray-700">作り方</h3>
      <div class="space-y-6" data-recipe-step-target="container">
        <% current_steps = Array(recipe.steps).flat_map { |s| s.to_s.split("\n") }.reject(&:blank?) %>
        <% current_steps = [""] if current_steps.empty? %>
        <% current_steps.each_with_index do |step, index| %>
          <div class="flex gap-4 items-start step-item">
            <div class="flex-none w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center font-bold text-gray-500"><%= index + 1 %></div>
            <div class="flex-grow">
              <%= text_area_tag "recipe[steps][]", step, placeholder: "手順#{index + 1}を入力...", class: "w-full bg-gray-50 border-gray-200 rounded-xl p-4 focus:bg-white focus:ring-2 focus:ring-orange-400 transition-all" %>
            </div>
          </div>
        <% end %>
      </div>
      <button type="button" data-action="click->recipe-step#add" class="mt-6 w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold hover:bg-gray-50 transition-all">+ ステップを追加する</button>
      <template data-recipe-step-target="template">
        <div class="flex gap-4 items-start mt-6 step-item">
          <div class="flex-none w-10 h-10 bg-orange-100 text-orange-600 font-black rounded-full flex items-center justify-center text-xl mt-1 step-number">NEW_INDEX</div>
          <div class="flex-grow">
            <%= text_area_tag "recipe[steps][]", nil, placeholder: "手順NEW_INDEXを入力...", class: "w-full bg-gray-50 border-gray-200 rounded-xl p-4 focus:bg-white focus:ring-2 focus:ring-orange-400 transition-all" %>
          </div>
        </div>
      </template>
    </div>

    <%# --- 下段：材料計算エリア --- %>
    <div class="bg-gray-200 p-8 rounded-sm relative">
      <%# 目安表モーダルコントローラー %>
      <div data-controller="modal">
        <button type="button" data-action="click->modal#open" class="text-sm font-bold text-orange-500 bg-orange-50 px-3 py-2 rounded-lg hover:bg-orange-100 transition shadow-sm mb-6 flex items-center gap-2">
          💡 食材の目安を確認
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 7l5 5m0 0l-5 5m5-5H6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
        </button>

        <div data-modal-target="container" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
          <div class="bg-white rounded-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto shadow-2xl">
            <div class="p-6">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-900">1人前の目安（グラム）</h3>
                <button type="button" data-action="click->modal#close" class="text-gray-400 hover:text-gray-600 text-3xl font-light">&times;</button>
              </div>
              
              <div class="space-y-6">
                <% [
                  { category: "🥩 肉・魚・メイン", color: "text-red-600",
                    items: [
                      { name: "肉（メイン）", weight: "100~150g", note: "鶏もも1枚は約250g" },
                      { name: "肉（炒め物）", weight: "80g", note: "豚こまなど" },
                      { name: "肉（ひき肉）", weight: "100g", note: "ハンバーグなど" },
                      { name: "魚切り身", weight: "80~100g", note: "1切れの標準" }
                    ]
                  },
                  { category: "🥗 野菜・炭水化物", color: "text-green-600",
                    items: [
                      { name: "たまねぎ", weight: "50g", note: "中サイズ1/4個" },
                      { name: "キャベツ", weight: "50g", note: "大判の葉 1枚" },
                      { name: "もやし", weight: "100g", note: "1袋の半分" },
                      { name: "ご飯", weight: "150g", note: "茶碗1杯分" }
                    ]
                  },
                  { category: "🧂 調味料（大さじ1）", color: "text-blue-600",
                    items: [
                      { name: "しょうゆ/酒/みりん", weight: "15~18g", note: "液体調味料" },
                      { name: "砂糖", weight: "10g", note: "粉末は軽い" }
                    ]
                  }
                ].each do |group| %>
                  <div>
                    <h4 class="text-xs font-black <%= group[:color] %> mb-2 px-1 uppercase tracking-wider"><%= group[:category] %></h4>
                    <div class="bg-gray-50 rounded-xl p-3 space-y-3">
                      <% group[:items].each do |item| %>
                        <div class="flex justify-between items-start border-b border-gray-200/50 last:border-0 pb-2 last:pb-0">
                          <div>
                            <div class="text-sm font-bold text-gray-800"><%= item[:name] %></div>
                            <div class="text-[10px] text-gray-400"><%= item[:note] %></div>
                          </div>
                          <div class="text-sm font-black text-gray-700"><%= item[:weight] %></div>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
              
              <button type="button" data-action="click->modal#close" class="w-full mt-6 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition-colors">とじる</button>
            </div>
          </div>
        </div>
      </div>

      <h3 class="text-2xl font-bold text-center mb-8">材料/グラム数</h3>
      <div class="flex flex-col md:flex-row gap-8 items-start">
        <div class="flex-grow space-y-4">
          <div data-recipe-calculation-target="container" class="space-y-3">
            <%= f.fields_for :recipe_ingredients do |ri_form| %>
              <%= render "ingredient_fields", f: ri_form %>
            <% end %>
          </div>
          <button type="button" data-action="click->recipe-calculation#add" class="w-full py-2 border-2 border-dashed border-gray-400 rounded text-gray-600 font-bold hover:bg-gray-100 transition-all">+ 材料を追加</button>
        </div>

        <div class="w-full md:w-64 bg-white p-6 shadow-md flex flex-col items-center justify-center min-h-[150px] sticky top-4 rounded-xl">
          <span class="text-xl font-bold mb-2 border-b-2 border-gray-800 w-full text-center">合計金額</span>
          <div class="text-3xl font-black mt-4 text-emerald-600">
            <span data-recipe-calculation-target="totalDisplay"><%= recipe.total_cost || 0 %></span> <span class="text-xl">円</span>
          </div>
          <div class="mt-6 pt-4 border-t border-dashed border-gray-300 w-full text-center">
            <span class="text-sm font-bold text-gray-500">今回の節約額</span>
            <div class="text-2xl font-black text-orange-500 mt-1">
              <span data-recipe-calculation-target="savingsDisplay"><%= recipe.savings_amount || 0 %></span> <span class="text-lg">円</span>
            </div>
          </div>
        </div>
      </div>
      
      <template data-recipe-calculation-target="template">
        <%= f.fields_for :recipe_ingredients, recipe.recipe_ingredients.build, child_index: "NEW_RECORD" do |ri_form| %>
          <%= render "ingredient_fields", f: ri_form %>
        <% end %>
      </template>
    </div>

    <%# 公開設定セクション %>
    <div class="bg-white p-6 rounded-2xl border-2 border-gray-100 shadow-sm mt-6">
      <label class="block text-lg font-bold text-gray-700 mb-2">公開設定</label>
      <div class="flex items-center space-x-4">
        <label class="relative inline-flex items-center cursor-pointer">
          <%= f.check_box :is_public, class: "sr-only peer" %>
          <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
          <span class="ml-3 text-sm font-medium text-gray-900"><%= f.object.is_public ? "公開" : "非公開" %></span>
        </label>
      </div>
      <p class="text-xs text-gray-500 mt-2">非公開：自分のみ閲覧可能 / 公開：みんなにシェア</p>
    </div>

    <%# 送信ボタン %>
    <div class="flex justify-center pt-8">
      <%= f.submit recipe.new_record? ? "登録する" : "更新する", class: "bg-green-400 hover:bg-green-500 text-white font-bold text-2xl py-4 px-20 rounded-xl shadow-lg transition-all active:transform active:scale-95 cursor-pointer" %>
    </div>

    <%= link_to recipes_path, class: "block text-center text-gray-500 font-bold bg-gray-100 hover:bg-gray-200 py-4 rounded-2xl transition-colors mt-4" do %>
      一覧に戻る
    <% end %>        
  <% end %>
</div>
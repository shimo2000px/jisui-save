name: Run RSpec
on: [push, pull_request]

jobs:
  rspec:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create dummy .env file
        run: touch .env

      - name: Build and run tests
        run: |
          cat <<EOF > compose.ci.yml
          services:
            db:
              image: postgres:15
              restart: always
              environment:
                POSTGRES_PASSWORD: password
              ports:
                - 5432:5432
            web:
              build:
                context: .
                dockerfile: Dockerfile
              user: root
              entrypoint: []
              command: sleep infinity
              volumes:
                - .:/rails
              environment:
                RAILS_ENV: test
                DATABASE_URL: postgresql://postgres:password@db:5432/postgres
              depends_on:
                - db
          EOF

          echo "Building images..."
          docker compose -f compose.ci.yml build

          echo "Starting containers..."
          docker compose -f compose.ci.yml up -d

          echo "Waiting for DB..."
          sleep 15

          echo "Setting up database..."
          docker compose -f compose.ci.yml exec -T -w /rails web bash -c "bundle install && bundle exec rails db:prepare"

          echo "Precompiling assets (Skip JS build if fails)..."
          docker compose -f compose.ci.yml exec -T -w /rails web bash -c "mkdir -p app/assets/builds && touch app/assets/builds/application.css && bundle exec rails assets:precompile" || echo "Assets precompile failed but continuing..."

          echo "Running RSpec..."
          docker compose -f compose.ci.yml exec -T -w /rails web bundle exec rspec